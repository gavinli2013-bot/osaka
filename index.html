<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é˜ªé¦¬æ‹‰æ¾èˆ‡å’Œæ­Œå±±è‡ªé§•ç™‚ç™’ä¹‹æ—… - äº’å‹•å°è¦½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        /* Custom Scrollbar for cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; 
        }
    </style>
    <!-- Chosen Palette: Warm Neutrals with Energetic Accents -->
    <!-- Palette Hex Codes: Background #F5F5F4 (Stone 100), Primary #EA580C (Orange 600 - Marathon), Secondary #0D9488 (Teal 600 - Onsen), Text #1C1917 (Stone 900) -->
    
    <!-- Application Structure Plan: 
         The application is designed as a 'Mission Dashboard' for the 4 travelers.
         1. **Header**: High-level trip summary (Dates, Temps, Goal).
         2. **Interactive Timeline (Left Col)**: A vertical navigation list representing the 5 days. Users click to reveal specific logistics.
         3. **Dynamic Detail View (Center/Right Col)**: Displays the specific itinerary, dining, accommodation, and the new Gemini-powered travel tip generation feature.
         4. **Data Visualization Dashboard (Bottom Section)**: 
            - Weather Forecast (Line Chart): To aid packing strategy.
            - Physical Load (Bar Chart): To visualize the effort vs. recovery phases.
            - Activity Balance (Doughnut): To show the 'Work hard, play hard' mix.
         5. **Route Flow (Visual Component)**: A CSS-based flow diagram for the Day 4 self-drive leg.
         This structure allows users to toggle between specific daily logistics and the 'big picture' planning data.
    -->
    
    <!-- Visualization & Content Choices: 
         1. **Weather Forecast (Line Chart)**: Goal: Inform/Plan. Shows temp range (4-10C). Chart.js used. Justification: Line chart best for continuous data ranges.
         2. **Physical Exertion (Bar Chart)**: Goal: Compare. Shows relative effort (5km vs 42km vs Rest). Chart.js used. Justification: Vertical bars make the Day 3 spike obvious.
         3. **Trip Composition (Doughnut Chart)**: Goal: Inform/Balance. Shows split between Running, Driving, Relaxing. Chart.js used. Justification: Easy to see the 'Healing' portion size.
         4. **Self-Drive Route (CSS Flow)**: Goal: Organize/Process. Shows the sequence of Day 4. HTML/Tailwind used. Justification: Linear progression from Osaka to Shirahama. No SVG used.
         5. **Interactive Day Selector**: Goal: Navigate. Vanilla JS updates the DOM content based on the selected day index.
         6. **Gemini API Integration**: Goal: Enhance/Update. Provides live, grounded travel tips for the current day's theme/location.
    -->

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-stone-100 text-stone-800 font-sans antialiased selection:bg-orange-200">

    <!-- App Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Header Section -->
        <header class="mb-10 text-center bg-white rounded-2xl shadow-sm p-8 border-t-8 border-orange-600">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-left">
                    <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-2">ğŸƒâ€â™‚ï¸ å¤§é˜ªé¦¬æ‹‰æ¾èˆ‡å’Œæ­Œå±±è‡ªé§•ç™‚ç™’ä¹‹æ—…</h1>
                    <p class="text-lg text-stone-600">2026å¹´2æœˆ20æ—¥ - 2æœˆ24æ—¥ | 4ä½ç”·å£« | å…¨é¦¬æŒ‘æˆ° + ç§˜å¢ƒæº«æ³‰</p>
                </div>
                <div class="mt-6 md:mt-0 flex gap-4">
                    <div class="bg-orange-50 px-6 py-3 rounded-xl border border-orange-100 text-center">
                        <span class="block text-2xl font-bold text-orange-600">4-10Â°C</span>
                        <span class="text-xs text-stone-500 font-bold uppercase">å¹³å‡æ°£æº«</span>
                    </div>
                    <div class="bg-teal-50 px-6 py-3 rounded-xl border border-teal-100 text-center">
                        <span class="block text-2xl font-bold text-teal-600">42.195</span>
                        <span class="text-xs text-stone-500 font-bold uppercase">å…¬é‡ŒæŒ‘æˆ°</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
            
            <!-- Left Column: Interactive Timeline Navigation -->
            <nav class="lg:col-span-3 bg-white rounded-2xl shadow-sm p-6 h-fit sticky top-6">
                <h3 class="text-stone-400 text-xs font-bold uppercase tracking-wider mb-4">è¡Œç¨‹å°è¦½</h3>
                <ul class="space-y-3" id="day-nav">
                    <!-- Nav items generated by JS -->
                </ul>
            </nav>

            <!-- Right Column: Dynamic Content Display -->
            <main class="lg:col-span-9 bg-white rounded-2xl shadow-sm p-8 min-h-[500px] flex flex-col justify-between" id="content-area">
                <!-- Content injected by JS -->
            </main>

        </div>

        <!-- Data Visualization Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            
            <!-- Chart 1: Physical Load -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-bold text-stone-900">é«”èƒ½è² è·é ä¼°</h3>
                    <p class="text-sm text-stone-500">æ¯æ—¥é ä¼°æ­¥è¡Œèˆ‡è·‘æ­¥ç¸½è·é›¢ (KM)</p>
                </div>
                <div class="chart-container">
                    <canvas id="loadChart"></canvas>
                </div>
                <p class="mt-4 text-xs text-stone-400 bg-stone-50 p-3 rounded">
                    <strong>åˆ†æï¼š</strong> Day 3 æ˜¯é«”èƒ½æ¥µé™ï¼ŒDay 4 èˆ‡ Day 5 å®‰æ’ç‚ºä½å¼·åº¦çš„æ¢å¾©æœŸï¼Œé‡é»åœ¨æ–¼è®“è‚Œè‚‰æ”¾é¬†ã€‚
                </p>
            </div>

            <!-- Chart 2: Trip Composition -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-bold text-stone-900">è¡Œç¨‹ä¸»é¡Œä½”æ¯”</h3>
                    <p class="text-sm text-stone-500">æ™‚é–“èˆ‡ç²¾åŠ›åˆ†é…åˆ†æ</p>
                </div>
                <div class="chart-container">
                    <canvas id="compChart"></canvas>
                </div>
                <p class="mt-4 text-xs text-stone-400 bg-stone-50 p-3 rounded">
                    <strong>å¹³è¡¡ï¼š</strong> é›–ç„¶æ ¸å¿ƒæ˜¯é¦¬æ‹‰æ¾ï¼Œä½†ã€Œç™‚ç™’ã€èˆ‡ã€Œç¾é£Ÿã€ä½”æ“šäº†è¶…éä¸€åŠçš„è¡Œç¨‹æ¯”é‡ï¼Œç¢ºä¿é€™æ˜¯ä¸€è¶Ÿæ”¾é¬†ä¹‹æ—…ã€‚
                </p>
            </div>

            <!-- Chart 3: Weather Strategy -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-bold text-stone-900">ç©¿è‘—ç­–ç•¥æ°£æº«åœ–</h3>
                    <p class="text-sm text-stone-500">å¤§é˜ª/å’Œæ­Œå±± 2æœˆé æ¸¬æ°£æº«</p>
                </div>
                <div class="chart-container">
                    <canvas id="weatherChart"></canvas>
                </div>
                <p class="mt-4 text-xs text-stone-400 bg-stone-50 p-3 rounded">
                    <strong>å»ºè­°ï¼š</strong> è³½äº‹ç•¶å¤©æ—©æ™¨æ¥µå†· (4Â°C)ï¼Œå‹™å¿…æº–å‚™æ‹‹æ£„å¼é›¨è¡£ä¿æš–ã€‚å’Œæ­Œå±±æµ·é‚Šé¢¨å¤§ï¼Œéœ€é˜²é¢¨å¤–å¥—ã€‚
                </p>
            </div>

        </section>

        <!-- Route Visualization (CSS Only) -->
        <section class="mt-12 bg-white rounded-2xl shadow-sm p-8 border-l-8 border-teal-500">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-stone-900">ğŸš— Day 4: ç´€ä¼ŠåŠå³¶è‡ªé§•å‹•ç·š</h3>
                <p class="text-stone-500">å¾ç¹è¯éƒ½å¸‚åˆ°æµ·æ¿±ç§˜å¢ƒçš„è½‰æ›</p>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-center relative gap-8 md:gap-4">
                <!-- Connector Line (Desktop) -->
                <div class="hidden md:block absolute top-1/2 left-0 w-full h-1 bg-stone-200 -z-10 transform -translate-y-1/2"></div>

                <!-- Step 1 -->
                <div class="bg-white border-2 border-stone-200 p-4 rounded-xl w-full md:w-1/4 text-center shadow-sm z-10">
                    <div class="text-3xl mb-2">ğŸ™ï¸</div>
                    <h4 class="font-bold text-stone-800">å¤§é˜ªå¸‚å€</h4>
                    <p class="text-xs text-stone-500">ä¸Šåˆå–è»Šå‡ºç™¼</p>
                </div>

                <!-- Arrow Mobile -->
                <div class="md:hidden text-stone-300 text-2xl">â¬‡ï¸</div>

                <!-- Step 2 -->
                <div class="bg-white border-2 border-orange-200 p-4 rounded-xl w-full md:w-1/4 text-center shadow-sm z-10">
                    <div class="text-3xl mb-2">ğŸ±</div>
                    <h4 class="font-bold text-orange-600">è²´å¿—ç«™</h4>
                    <p class="text-xs text-stone-500">æ¢è¨ªè²“ç«™é•· (1.5hr)</p>
                </div>

                <!-- Arrow Mobile -->
                <div class="md:hidden text-stone-300 text-2xl">â¬‡ï¸</div>

                <!-- Step 3 -->
                <div class="bg-white border-2 border-stone-200 p-4 rounded-xl w-full md:w-1/4 text-center shadow-sm z-10">
                    <div class="text-3xl mb-2">ğŸ›£ï¸</div>
                    <h4 class="font-bold text-stone-800">æ²¿æµ·è‡ªé§•</h4>
                    <p class="text-xs text-stone-500">é˜ªå’Œè‡ªå‹•è»Šé“ (2.5hr)</p>
                </div>

                <!-- Arrow Mobile -->
                <div class="md:hidden text-stone-300 text-2xl">â¬‡ï¸</div>

                <!-- Step 4 -->
                <div class="bg-white border-2 border-teal-200 p-4 rounded-xl w-full md:w-1/4 text-center shadow-sm z-10">
                    <div class="text-3xl mb-2">â™¨ï¸</div>
                    <h4 class="font-bold text-teal-600">å—ç´€ç™½æ¿±</h4>
                    <p class="text-xs text-stone-500">éœ²å¤©æº«æ³‰èˆ‡è±ªè¯æ™šé¤</p>
                </div>
            </div>
        </section>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // Data Store
        const itineraryData = [
            {
                day: "Day 1",
                date: "2/20 (äº”)",
                title: "æŠµé”èˆ‡è³½äº‹æº–å‚™",
                theme: "blue", // UI highlight color
                icon: "ğŸ›¬",
                main_location: "å¤§é˜ªå¸‚å€ é›£æ³¢æ¢…ç”°",
                morning: "æŠµé”é—œè¥¿æ©Ÿå ´ (KIX) â†’ é›»è»Šè‡³å¤§é˜ªå¸‚å€ â†’ é…’åº— Check-in",
                afternoon: "è¼•é‡è³¼ç‰© (è£œçµ¦å“) â†’ å¿ƒé½‹æ©‹/é“é “å €æ•£æ­¥ç†Ÿæ‚‰ç’°å¢ƒ",
                dinner: "Carbo-loading æº–å‚™ï¼šè¼•é£Ÿæ™šé¤ï¼Œé¿å…æ²¹è†©",
                stay: "å¤§é˜ªå¸‚å€ (é›£æ³¢/æ¢…ç”°) - æ¨è–¦è¨­æœ‰å¤§æµ´å ´çš„å››äººæˆ¿",
                details: "ç¬¬ä¸€å¤©é‡é»åœ¨æ–¼æ¸›å°‘ç§»å‹•ç–²å‹ã€‚å¿ƒé½‹æ©‹äººå¤šï¼Œå»ºè­°åªåšå¿…è¦è³¼ç‰©ã€‚å››äººæˆ¿éœ€ææ—©ç¢ºèªåºŠä½é…ç½®ã€‚æ™šé¤é¸æ“‡æ¸…æ·¡çš„å’Œé£Ÿï¼Œç‚ºè…¸èƒƒæ¸›è² ã€‚",
                highlight: "å››äººä½å®¿"
            },
            {
                day: "Day 2",
                date: "2/21 (å…­)",
                title: "åšè¦½æœƒèˆ‡ Carbo-loading",
                theme: "orange",
                icon: "ğŸ½",
                main_location: "å¤§é˜ªé¦¬æ‹‰æ¾åšè¦½æœƒ INTEX Osaka",
                morning: "è³½å‰æ…¢è·‘ï¼šå¤§é˜ªåŸå…¬åœ’ (ç´„5km) + æ‹‰ä¼¸",
                afternoon: "å‰å¾€ INTEX å¤§é˜ªé ˜å–è™Ÿç¢¼å¸ƒ + åƒè§€åšè¦½æœƒ (éœ€é ç•™3-4å°æ™‚)",
                dinner: "é«˜å“è³ª Carbo-loadingï¼šé«˜è³ªç´ ã€æ˜“æ¶ˆåŒ–ä¹‹é¤å»³ (å¦‚ç¾ç¾å¯çƒé¾éºµæˆ–é«˜ç´šæ„å¼éºµé£Ÿ)",
                stay: "å¤§é˜ªå¸‚å€ (åŒä¸Š) - å››äººåŒä½",
                details: "åšè¦½æœƒäººæ½®çœ¾å¤šï¼Œå»ºè­°é ˜å®Œç‰©è³‡ç›¡å¿«é›¢é–‹ï¼Œé¿å…ä¹…ç«™æ¶ˆè€—è…¿åŠ›ã€‚æ™šé¤æ˜¯è³½å‰æœ€å¾Œä¸€é¤ï¼Œå‹™å¿…é¸æ“‡é«˜ç¢³æ°´ã€é«˜å“è³ªçš„é£Ÿç‰©ï¼Œç‚ºéš”å¤©å„²å‚™èƒ½é‡ã€‚",
                highlight: "é«˜è³ªé¤é»"
            },
            {
                day: "Day 3",
                date: "2/22 (æ—¥)",
                title: "å¤§é˜ªé¦¬æ‹‰æ¾æ—¥",
                theme: "red",
                icon: "ğŸ”¥",
                main_location: "å¤§é˜ªé¦¬æ‹‰æ¾èµ·é»èˆ‡è·¯ç·š",
                morning: "å¤§é˜ªé¦¬æ‹‰æ¾åƒè³½ (èµ·è·‘é»ï¼šå¤§é˜ªåºœå»³å‰)",
                afternoon: "å®Œè³½ â†’ é ˜å–è¡Œæ â†’ å‰å¾€å¸‚å€æº«æ³‰ (Spa World) æ”¾é¬†è‚Œè‚‰",
                dinner: "ğŸ‰ æ…¶åŠŸå®´ï¼šé«˜è³ªç´ ã€å…·åœ°æ–¹ç‰¹è‰²çš„é¤å»³ (å¦‚é«˜ç´šä¸²ç‚¸/ç²¾ç·»å¤§é˜ªç‡’)",
                stay: "å¤§é˜ªå¸‚å€ (åŒä¸Š) - å››äººå…±äº«å–œæ‚…",
                details: "é€™æ˜¯æ—…ç¨‹çš„é«˜æ½®ï¼å®Œè³½å¾Œçš„ç¬¬ä¸€ä»¶äº‹ä¸æ˜¯ç¡è¦ºï¼Œè€Œæ˜¯å†·ç†±äº¤æ›¿æµ´æˆ–æ³¡æº«æ³‰ï¼Œèƒ½å¤§å¹…æ¸›å°‘éš”å¤©çš„ç— ç—›ã€‚æ™šé¤é¸æ“‡é«˜è³ªç´ é¤å»³ï¼Œå¥½å¥½çŠ’è³è‡ªå·±å’ŒéšŠå‹ï¼",
                highlight: "æ…¶åŠŸç¾é£Ÿ"
            },
            {
                day: "Day 4",
                date: "2/23 (ä¸€)",
                title: "è²“å’ªå‚³å¥‡èˆ‡ç§˜å¢ƒæº«æ³‰",
                theme: "teal",
                icon: "ğŸ±",
                main_location: "å’Œæ­Œå±± æ¾„æ³‰æ—…é¤¨ å—ç´€ç™½æ¿±æº«æ³‰",
                morning: "å¤§é˜ªç§Ÿè»Š â†’ å’Œæ­Œå±±è²´å¿—ç«™ (æ¢è¨ªè²“ç«™é•·å››ä»£ç‰)",
                afternoon: "ç§˜å¢ƒè‡ªé§•ï¼šç›´å¥”å—ç´€ç™½æ¿±æº«æ³‰å€ (ç´„2.5å°æ™‚)",
                dinner: "â™¨ï¸ æ¾„æ³‰æ—…é¤¨ï¼šé«˜è³ªç´ æ‡·çŸ³æ–™ç† (åœ¨æ—…é¤¨å…§äº«ç”¨)",
                stay: "å—ç´€ç™½æ¿±ï¼šæ¾„æ³‰æ—…é¤¨ (å››äººä½å®¿)",
                details: "è½‰æ›å¿ƒæƒ…çš„ä¸€å¤©ã€‚ä¸‹åˆæŠµé”æ¾„æ³‰æ—…é¤¨å¾Œï¼Œæ‡‰ç«‹å³äº«å—æº«æ³‰ï¼Œèˆ’ç·©é¦¬æ‹‰æ¾å¾Œçš„ç–²æ†Šã€‚æ™šé¤çš„æ‡·çŸ³æ–™ç†æ˜¯å’Œæ­Œå±±ä¹‹è¡Œçš„é«˜ç´šäº«å—ã€‚",
                highlight: "æ¾„æ³‰ä½å®¿"
            },
            {
                day: "Day 5",
                date: "2/24 (äºŒ)",
                title: "æµ·æ™¯æº«æ³‰èˆ‡è¿”ç¨‹",
                theme: "indigo",
                icon: "ğŸŒŠ",
                main_location: "å—ç´€ç™½æ¿± å´ä¹‹æ¹¯ åƒç–Šæ•·",
                morning: "æ™¨é–“æ¢å¾©ï¼šç™½è‰¯æ¿±æ²™ç˜æ•£æ­¥ + å´ä¹‹æ¹¯ (æµ·é‚Šéœ²å¤©æº«æ³‰)",
                afternoon: "åƒè§€åƒç–Šæ•·/ä¸‰æ®µå£ â†’ é§•è»Šè¿”å› KIX æ©Ÿå ´é‚„è»Š",
                dinner: "æ©Ÿä¸Š/æ©Ÿå ´ç°¡é¤",
                stay: "æº«æš–çš„å®¶",
                details: "å´ä¹‹æ¹¯è·é›¢æµ·æµªåªæœ‰å’«å°ºä¹‹é™ï¼Œæ˜¯æ¥µç‚ºé›£å¾—çš„é«”é©—ã€‚åˆ©ç”¨æ—©æ™¨æ™‚é–“å¾¹åº•æ’æ¯’ï¼Œå¸¶è‘—å°æ¾„æ³‰æ—…é¤¨çš„ç¾å¥½å›æ†¶è¿”å›é¦™æ¸¯ã€‚",
                highlight: "å®Œç¾å¥é»"
            }
        ];

        // State Management
        let currentDayIndex = 0;

        // DOM Elements
        const navList = document.getElementById('day-nav');
        const contentArea = document.getElementById('content-area');

        // Gemini API Configuration
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Helper for Tailwind colors
        function getColor(theme) {
            const map = {
                'blue': 'blue',
                'orange': 'orange',
                'red': 'red',
                'teal': 'teal',
                'indigo': 'indigo'
            };
            return map[theme] || 'gray';
        }
        
        // --- Gemini API Call Function with Exponential Backoff ---
        async function fetchGeminiTip(prompt, maxRetries = 5) {
            const outputDiv = document.getElementById('gemini-tip-output');
            const button = document.getElementById('gemini-tip-button');
            
            if (!outputDiv || !button) return;

            outputDiv.innerHTML = '<div class="text-center py-4 text-stone-500 flex items-center justify-center space-x-2"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-orange-600"></div><span class="text-sm">æ­£åœ¨å¾ç¶²çµ¡ç²å–æœ€æ–°è³‡è¨Š...</span></div>';
            button.disabled = true;

            const systemPrompt = "ä½ æ˜¯ä¸€ä½ç¶“é©—è±å¯Œçš„æ—¥æœ¬æ—…éŠå°ˆå®¶ï¼Œå°ˆé–€ç‚ºé«˜ç«¯æ—…è¡Œåœ˜æä¾›å»ºè­°ã€‚æ ¹æ“šç”¨æˆ¶æä¾›çš„æ¯æ—¥è¡Œç¨‹ä¸»é¡Œï¼Œè«‹åˆ©ç”¨æœ€æ–°çš„ç¶²çµ¡è³‡è¨Šï¼Œæä¾›ä¸€å€‹ç°¡æ½”ã€å¯¦ç”¨ä¸”é«˜è³ªé‡çš„æ—…éŠå°è²¼å£«æˆ–ç•¶æ—¥æ´»å‹•çš„ç¨å®¶å»ºè­°ã€‚è«‹ä¿æŒå°ˆæ¥­ä¸”å‹å–„çš„èªæ°£ï¼Œçµæœå¿…é ˆåœ¨ä¸€å€‹æ®µè½å…§å®Œæˆã€‚";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;

                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title)
                                .slice(0, 3); // Limit to 3 sources for clean UI
                        }

                        let sourceHtml = '';
                        if (sources.length > 0) {
                            sourceHtml = `
                                <h5 class="text-xs font-bold text-stone-500 mt-4 mb-2">åƒè€ƒä¾†æº (Google æœç´¢):</h5>
                                <ul class="text-xs space-y-1">
                                    ${sources.map((src, idx) => `
                                        <li class="truncate"><a href="${src.uri}" target="_blank" class="text-blue-600 hover:underline">${idx + 1}. ${src.title}</a></li>
                                    `).join('')}
                                </ul>
                            `;
                        }

                        outputDiv.innerHTML = `
                            <h4 class="text-lg font-bold text-stone-800 mb-3 flex items-center">
                                <span class="text-orange-600 mr-2">ğŸŒŸ</span> Gemini æ—…éŠæ™ºæ…§
                            </h4>
                            <p class="text-stone-700 leading-relaxed">${text}</p>
                            ${sourceHtml}
                        `;
                    } else {
                        outputDiv.innerHTML = '<div class="p-4 bg-red-100 text-red-700 rounded-lg text-sm">æŠ±æ­‰ï¼Œç„¡æ³•ç”Ÿæˆç›¸é—œå»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
                    }
                    break; // Success or non-retryable error, exit loop

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i === maxRetries - 1) {
                        outputDiv.innerHTML = '<div class="p-4 bg-red-100 text-red-700 rounded-lg text-sm">ç¶²çµ¡éŒ¯èª¤æˆ–ä¼ºæœå™¨è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šæˆ–é‡è©¦ã€‚</div>';
                    }
                }
            }
            button.disabled = false;
        }

        // Render Navigation
        function renderNav() {
            navList.innerHTML = '';
            itineraryData.forEach((item, index) => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                const isActive = index === currentDayIndex;
                
                let activeClass = isActive ? 'bg-orange-600 text-white shadow-md transform scale-105' : 'bg-stone-50 text-stone-600 hover:bg-stone-100';
                
                btn.className = `w-full text-left px-4 py-3 rounded-xl transition-all duration-200 flex items-center gap-3 ${activeClass}`;
                btn.onclick = () => {
                    currentDayIndex = index;
                    renderNav();
                    renderContent();
                };
                
                btn.innerHTML = `
                    <span class="text-xl">${item.icon}</span>
                    <div>
                        <div class="text-xs font-bold opacity-70">${item.day}</div>
                        <div class="font-bold text-sm truncate">${item.title}</div>
                    </div>
                `;
                li.appendChild(btn);
                navList.appendChild(li);
            });
        }

        // Render Content
        function renderContent() {
            const data = itineraryData[currentDayIndex];
            
            contentArea.classList.add('opacity-0', 'translate-y-2');
            
            setTimeout(() => {
                contentArea.innerHTML = `
                    <div class="border-b border-stone-100 pb-6 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <span class="bg-${getColor(data.theme)}-100 text-${getColor(data.theme)}-700 px-3 py-1 rounded-full text-xs font-bold mb-2 inline-block">${data.date}</span>
                            <h2 class="text-3xl font-bold text-stone-800">${data.title}</h2>
                        </div>
                        <div class="mt-4 md:mt-0 flex flex-col items-start md:items-end space-y-2">
                            <button id="gemini-tip-button" class="flex items-center space-x-2 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 shadow-md shadow-teal-200">
                                <span>âœ¨ ç²å–æœ€æ–°æ—…éŠå°è²¼å£«</span>
                            </button>
                            <div class="bg-stone-50 p-3 rounded-xl text-center min-w-[80px]">
                                <div class="text-xs text-stone-400 font-bold uppercase">é‡é»</div>
                                <div class="text-stone-800 font-bold">${data.highlight}</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="space-y-6">
                            <div class="flex gap-4">
                                <div class="bg-blue-50 w-10 h-10 rounded-full flex items-center justify-center text-blue-500 shrink-0 font-bold">AM</div>
                                <div>
                                    <h4 class="font-bold text-stone-800">ä¸Šåˆè¡Œç¨‹</h4>
                                    <p class="text-stone-600 text-sm leading-relaxed">${data.morning}</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="bg-orange-50 w-10 h-10 rounded-full flex items-center justify-center text-orange-500 shrink-0 font-bold">PM</div>
                                <div>
                                    <h4 class="font-bold text-stone-800">ä¸‹åˆè¡Œç¨‹</h4>
                                    <p class="text-stone-600 text-sm leading-relaxed">${data.afternoon}</p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="flex gap-4">
                                <div class="bg-indigo-50 w-10 h-10 rounded-full flex items-center justify-center text-indigo-500 shrink-0 text-xl">ğŸ½ï¸</div>
                                <div>
                                    <h4 class="font-bold text-stone-800">æ™šé¤æ¨è–¦</h4>
                                    <p class="text-stone-600 text-sm leading-relaxed">${data.dinner}</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="bg-teal-50 w-10 h-10 rounded-full flex items-center justify-center text-teal-500 shrink-0 text-xl">ğŸ¨</div>
                                <div>
                                    <h4 class="font-bold text-stone-800">ä½å®¿å®‰æ’</h4>
                                    <p class="text-stone-600 text-sm leading-relaxed">${data.stay}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="gemini-tip-output" class="p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded-xl mb-6">
                        <div class="text-stone-500 text-sm">é»æ“Šä¸Šæ–¹çš„ã€Œâœ¨ ç²å–æœ€æ–°æ—…éŠå°è²¼å£«ã€æŒ‰éˆ•ï¼Œè®“AIç‚ºæ‚¨å³æ™‚ç”Ÿæˆé—œæ–¼ç•¶æ—¥è¡Œç¨‹çš„å¯¦ç”¨å»ºè­°ã€‚</div>
                    </div>

                    <div class="bg-stone-50 p-6 rounded-xl border border-stone-100 mt-auto">
                        <h4 class="text-sm font-bold text-stone-500 uppercase mb-2">ğŸ’¡ å°ˆå®¶å°è²¼å£« (è¡Œç¨‹åŸæœ‰å»ºè­°)</h4>
                        <p class="text-stone-700 italic">"${data.details}"</p>
                    </div>
                `;
                
                contentArea.classList.remove('opacity-0', 'translate-y-2');
                contentArea.classList.add('transition-all', 'duration-300', 'ease-out');

                // Attach event listener for the new button
                document.getElementById('gemini-tip-button').onclick = () => {
                    const currentData = itineraryData[currentDayIndex];
                    const prompt = `è«‹æä¾›é—œæ–¼ ${currentData.date} çš„è¡Œç¨‹ä¸»é¡Œï¼š${currentData.title}ï¼Œä»¥åŠé—œéµåœ°é»ï¼š${currentData.main_location} çš„æœ€æ–°æ—…éŠå°è²¼å£«æˆ–ç•¶å‰å»ºè­°ã€‚`;
                    fetchGeminiTip(prompt);
                };
            }, 100);
        }

        // Chart.js Implementations
        function initCharts() {
            const tooltipConfig = {
                callbacks: {
                    title: function(tooltipItems) {
                        const item = tooltipItems[0];
                        const label = item.chart.data.labels[item.dataIndex];
                        return Array.isArray(label) ? label.join(' ') : label;
                    }
                }
            };

            new Chart(document.getElementById('loadChart'), {
                type: 'bar',
                data: {
                    labels: [['Day 1', 'æŠµé”'], ['Day 2', 'æ…¢è·‘'], ['Day 3', 'é¦¬æ‹‰æ¾'], ['Day 4', 'è‡ªé§•'], ['Day 5', 'æ¢å¾©']],
                    datasets: [{
                        label: 'æ´»å‹•è·é›¢ (KM)',
                        data: [5, 10, 45, 3, 4],
                        backgroundColor: ['#d6d3d1', '#fb923c', '#ea580c', '#2dd4bf', '#818cf8'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: tooltipConfig },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });

            new Chart(document.getElementById('compChart'), {
                type: 'doughnut',
                data: {
                    labels: ['è·‘æ­¥èˆ‡è³½äº‹', 'æº«æ³‰èˆ‡ç™‚ç™’', 'äº¤é€šè‡ªé§•', 'ç¾é£Ÿæ¢ç´¢'],
                    datasets: [{
                        data: [35, 30, 20, 15],
                        backgroundColor: ['#ea580c', '#0d9488', '#57534e', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { font: { size: 10 }, boxWidth: 10 } }, tooltip: tooltipConfig }
                }
            });

            new Chart(document.getElementById('weatherChart'), {
                type: 'line',
                data: {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                    datasets: [
                        {
                            label: 'æœ€é«˜æº«',
                            data: [9, 10, 10, 9, 8],
                            borderColor: '#ea580c',
                            tension: 0.4
                        },
                        {
                            label: 'æœ€ä½æº«',
                            data: [4, 5, 4, 4, 5],
                            borderColor: '#3b82f6',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' }, tooltip: tooltipConfig },
                    scales: { y: { min: 0, max: 15 } }
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderNav();
            renderContent();
            initCharts();
        });

    </script>
</body>
</html>